{% extends 'dashboard/base.html' %}

{% block title %}Perfil - ByteNest{% endblock %}

{% block meta_description %}Gerencie seu perfil e informações pessoais na ByteNest.{% endblock %}

{% block dashboard_content %}
<div class="py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        <i class="fas fa-user mr-3"></i>
        Meu Perfil
      </h1>
      <p class="text-gray-600">
        Gerencie suas informações pessoais e configurações da conta
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Profile Info -->
      <div class="lg:col-span-2">
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">
              Informações Pessoais
            </h3>
            
            <form id="profileForm" class="space-y-6">
              {% csrf_token %}
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                    Nome
                  </label>
                  <input type="text" id="first_name" name="first_name" 
                         value="{{ user.first_name|default:'' }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div>
                  <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                    Sobrenome
                  </label>
                  <input type="text" id="last_name" name="last_name" 
                         value="{{ user.last_name|default:'' }}"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                  Email
                </label>
                <input type="email" id="email" name="email" 
                       value="{{ user.email }}" disabled
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                <p class="text-xs text-gray-500 mt-1">O email não pode ser alterado</p>
              </div>

              <div class="flex justify-end">
                <button type="submit" id="saveBtn" 
                        class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300">
                  <i class="fas fa-save mr-2"></i>
                  <span id="saveText">Salvar Alterações</span>
                </button>
              </div>

              <div id="formMessage" class="hidden p-4 rounded-lg text-center"></div>
            </form>
          </div>
        </div>
      </div>

      <!-- Profile Sidebar -->
      <div>
        <!-- Profile Picture -->
        <div class="bg-white shadow rounded-lg mb-6">
          <div class="px-4 py-5 sm:p-6 text-center">
            <div class="mx-auto h-24 w-24 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mb-4">
              <span class="text-white font-bold text-2xl">
                {{ user.first_name|default:user.email|first|upper }}
              </span>
            </div>
            <h3 class="text-lg font-medium text-gray-900">
              {{ user.first_name|default:user.email }}
            </h3>
            <p class="text-sm text-gray-500">{{ user.email }}</p>
            <button class="mt-4 text-purple-600 hover:text-purple-500 text-sm font-medium">
              <i class="fas fa-camera mr-1"></i>
              Alterar Foto
            </button>
          </div>
        </div>

        <!-- Account Stats -->
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
              Estatísticas da Conta
            </h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Membro desde</span>
                <span class="text-sm font-medium text-gray-900">{{ user.date_joined|date:"d/m/Y" }}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Último login</span>
                <span class="text-sm font-medium text-gray-900">{{ user.last_login|date:"d/m/Y H:i"|default:"Primeiro acesso" }}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Projetos ativos</span>
                <span class="text-sm font-medium text-gray-900">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Projetos concluídos</span>
                <span class="text-sm font-medium text-gray-900">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white shadow rounded-lg mt-6">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
              Ações Rápidas
            </h3>
            <div class="space-y-3">
              <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                <i class="fas fa-key mr-2"></i>
                Alterar Senha
              </button>
              <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                <i class="fas fa-bell mr-2"></i>
                Notificações
              </button>
              <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                <i class="fas fa-download mr-2"></i>
                Exportar Dados
              </button>
              <button class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                <i class="fas fa-trash mr-2"></i>
                Excluir Conta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('profileForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const saveBtn = document.getElementById('saveBtn');
  const saveText = document.getElementById('saveText');
  const formMessage = document.getElementById('formMessage');
  
  // Get form data
  const formData = new FormData(this);
  const data = {
    first_name: formData.get('first_name'),
    last_name: formData.get('last_name')
  };
  
  // Show loading state
  saveBtn.disabled = true;
  saveText.textContent = 'Salvando...';
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>Salvando...</span>';
  
  try {
    const response = await fetch('/dashboard/profile/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      formMessage.className = 'p-4 rounded-lg text-center bg-green-100 text-green-800 border border-green-200';
      formMessage.textContent = result.message;
      formMessage.classList.remove('hidden');
      
      // Hide message after 3 seconds
      setTimeout(() => {
        formMessage.classList.add('hidden');
      }, 3000);
    } else {
      formMessage.className = 'p-4 rounded-lg text-center bg-red-100 text-red-800 border border-red-200';
      formMessage.textContent = result.message;
      formMessage.classList.remove('hidden');
    }
  } catch (error) {
    formMessage.className = 'p-4 rounded-lg text-center bg-red-100 text-red-800 border border-red-200';
    formMessage.textContent = 'Erro ao salvar perfil. Tente novamente.';
    formMessage.classList.remove('hidden');
  } finally {
    // Reset button state
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i><span>Salvar Alterações</span>';
  }
});
</script>
{% endblock %}
